---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import fs from 'node:fs';
import path from 'node:path';

// Get curated posts from content collection
const postEntries = await getCollection('posts');

// Get automatically detected files from public/uploads
const uploadsDir = './public/uploads';
let uploadFiles = [];

if (fs.existsSync(uploadsDir)) {
    uploadFiles = fs.readdirSync(uploadsDir)
        .filter(file => /\.(jpg|jpeg|png|webp|mp4|mov|webm)$/i.test(file))
        .map(file => {
            const stats = fs.statSync(path.join(uploadsDir, file));
            const isVideo = /\.(mp4|mov|webm)$/i.test(file);
            return {
                slug: `upload-${file}`,
                data: {
                    title: file,
                    date: stats.mtime,
                    image: isVideo ? null : `/uploads/${file}`,
                    video: isVideo ? `/uploads/${file}` : null,
                },
                isUpload: true
            };
        });
}

// Combine and sort
const posts = [...postEntries, ...uploadFiles].sort(
	(a, b) => b.data.date.valueOf() - a.data.date.valueOf()
);
---

<Layout title="It's Chill - Media">
	<main id="app">
        <header class="hero">
			<a href="/" style="text-decoration: none;">
                <img src="/logo.png" alt="It's Chill" class="title logo" />
            </a>
			<h1 class="subtitle">chill media.</h1>
		</header>

		<div class="content">
            <div class="media-grid">
                {posts.map((post) => (
                    <a href={`/media/${post.slug}`} class="media-item reveal">
                        {post.data.image && <img src={post.data.image} alt="Chill Media" loading="lazy" />}
                        {post.data.video && (
                            <div class="video-container">
                                {!post.data.image && <div class="video-placeholder"></div>}
                                <div class="video-indicator">▶</div>
                            </div>
                        )}
                    </a>
                ))}
            </div>
		</div>
        <div style="text-align: center; margin-top: 4rem;">
            <a href="/" style="color: var(--color-text); text-decoration: none;">← Home</a>
        </div>
	</main>
</Layout>

<script>
    // Scroll reveal logic
	const observer = new IntersectionObserver((entries) => {
		entries.forEach(entry => {
			if (entry.isIntersecting) {
				entry.target.classList.add('active');
				observer.unobserve(entry.target);
			}
		});
	});

	document.querySelectorAll('.reveal').forEach(el => {
		observer.observe(el);
	});
</script>

<style>
    .media-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1.5rem;
        padding: 1rem 0;
    }
    .media-item {
        display: block;
        border-radius: var(--radius-md);
        overflow: hidden;
        position: relative;
        transition: transform 0.3s ease;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        cursor: pointer;
        background: #f0f0f0;
        aspect-ratio: 1 / 1;
    }
    .media-item:hover {
        transform: translateY(-5px);
    }
    .media-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }
    .video-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .video-placeholder {
        width: 100%;
        height: 100%;
        background: #222;
    }
    .video-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 2rem;
        color: white;
        background: rgba(0,0,0,0.5);
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        z-index: 2;
    }
</style>
