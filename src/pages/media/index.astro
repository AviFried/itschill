---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import fs from 'node:fs';
import path from 'node:path';
import { formatMediaSlug } from '../../utils/slugify';

// Get curated posts from content collection
const postEntries = await getCollection('posts');

// Get automatically detected files from public/uploads
const uploadsDir = './public/uploads';
let uploadFiles = [];

if (fs.existsSync(uploadsDir)) {
    const files = fs.readdirSync(uploadsDir)
        .filter(file => /\.(jpg|jpeg|png|webp|mp4|mov|webm)$/i.test(file));
    
    uploadFiles = files.map(file => {
        const stats = fs.statSync(path.join(uploadsDir, file));
        const isVideo = /\.(mp4|mov|webm)$/i.test(file);
        return {
            slug: formatMediaSlug(file, stats.mtime),
            data: {
                title: file.replace(/\.[^/.]+$/, "").replace(/[-_]/g, " "),
                date: stats.mtime,
                image: isVideo ? null : `/uploads/${file}`,
                video: isVideo ? `/uploads/${file}` : null,
            },
            isUpload: true
        };
    });
}

// Combine and sort
const posts = [...postEntries, ...uploadFiles].sort(
	(a, b) => b.data.date.valueOf() - a.data.date.valueOf()
);
---

<Layout title="It's Chill - Media">
	<main id="app">
        <header class="hero">
			<a href="/" style="text-decoration: none;">
                <img src="/logo.png" alt="It's Chill" class="title logo" />
            </a>
			<p class="subtitle">chill media.</p>
            <nav style="margin-top: 1rem; display: flex; justify-content: center; gap: 2rem;">
                <a href="/" style="color: var(--color-secondary); text-decoration: none; font-weight: bold; border-bottom: 2px solid var(--color-primary);">Home</a>
                <a href="https://shop.itschill.org" style="color: var(--color-secondary); text-decoration: none; font-weight: bold; border-bottom: 2px solid var(--color-primary);">Shop</a>
            </nav>
		</header>

		<div class="content">
            <div class="media-masonry">
                {posts.map((post) => (
                    <a href={`/media/${post.slug}`} class="media-item reveal">
                        <div class="media-wrapper">
                            {post.data.image && (
                                <img 
                                    src={post.data.image} 
                                    alt="Chill Media" 
                                    loading="lazy" 
                                    transition:name={`media-${post.slug}`}
                                />
                            )}
                            {post.data.video && (
                                <div class="video-preview">
                                    <video 
                                        autoplay 
                                        muted 
                                        loop 
                                        playsinline 
                                        transition:name={`media-${post.slug}`}
                                    >
                                        <source src={post.data.video} type={`video/${post.data.video.split('.').pop()}`} />
                                    </video>
                                    <div class="video-overlay">
                                        <div class="video-indicator">â–¶</div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </a>
                ))}
            </div>
		</div>
        <footer class="footer">
			<p>Stay Chill.</p>
            <nav style="margin-top: 1rem; display: flex; justify-content: center; gap: 1.5rem; opacity: 0.8;">
                <a href="/" style="color: var(--color-text); text-decoration: none; font-size: 0.9rem;">Home</a>
                <a href="/media" style="color: var(--color-text); text-decoration: none; font-size: 0.9rem;">Previous Posts</a>
                <a href="https://shop.itschill.org" style="color: var(--color-text); text-decoration: none; font-size: 0.9rem;">Shop</a>
            </nav>
			<p class="dedication">L'ilui Nishmas Etta Ahuva bas Yaakov<br />and Toba bas Yehoshua Yaakov</p>
		</footer>
	</main>
</Layout>

<script>
    // Scroll reveal logic - re-initialize on view transitions
	function initReveal() {
		const observer = new IntersectionObserver((entries) => {
			entries.forEach(entry => {
				if (entry.isIntersecting) {
					entry.target.classList.add('active');
					observer.unobserve(entry.target);
				}
			});
		});

		document.querySelectorAll('.reveal').forEach(el => {
			// Reset and observe
			el.classList.remove('active');
			observer.observe(el);
		});
	}

	// Initialize on page load
	initReveal();

	// Re-initialize after view transitions
	document.addEventListener('astro:page-load', () => {
		initReveal();
	});
</script>

<style>
    .media-masonry {
        columns: 3 250px;
        column-gap: 1.5rem;
        padding: 1rem 0;
    }
    .media-item {
        display: block;
        break-inside: avoid;
        margin-bottom: 1.5rem;
        border-radius: var(--radius-md);
        overflow: hidden;
        position: relative;
        transition: transform 0.3s ease;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        cursor: pointer;
        background: #f0f0f0;
    }
    .media-wrapper {
        width: 100%;
        height: auto;
    }
    .media-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .media-item img, .media-item video {
        width: 100%;
        height: auto;
        display: block;
    }
    .video-preview {
        position: relative;
        width: 100%;
    }
    .video-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.3s ease;
    }
    .media-item:hover .video-overlay {
        background: rgba(0,0,0,0.2);
    }
    .video-indicator {
        font-size: 1.5rem;
        color: white;
        background: rgba(0,0,0,0.3);
        backdrop-filter: blur(4px);
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        border: 1px solid rgba(255,255,255,0.2);
        z-index: 2;
        transition: transform 0.3s ease;
    }
    .media-item:hover .video-indicator {
        transform: scale(1.1);
    }
    
    @media (max-width: 800px) {
        .media-masonry {
            columns: 2 200px;
        }
    }
    @media (max-width: 500px) {
        .media-masonry {
            columns: 1;
        }
    }
</style>
